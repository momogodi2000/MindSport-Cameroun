{% extends 'Dashboards/Layout/chat_base.html' %}
{% load static %}

{% block head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/gsap@3.11.4/dist/gsap.min.js"></script>
<style>
    :root {
        --primary: #4f46e5;
        --primary-light: #6366f1;
        --primary-dark: #4338ca;
        --secondary: #64748b;
        --success: #10b981;
        --danger: #ef4444;
        --light: #f3f4f6;
        --dark: #1f2937;
        --surface: #ffffff;
        --surface-dark: #f9fafb;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .chat-app {
        max-height: 100vh;
        overflow: hidden;
    }

    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 5px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
        background: var(--light);
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: var(--secondary);
    }

    /* Message animations */
    .message-bubble {
        transition: transform 0.2s ease;
        opacity: 1;
    }
    
    .message-bubble:hover {
        transform: translateY(-2px);
    }
    
    /* Typing indicator */
    .typing-indicator span {
        display: inline-block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: var(--secondary);
        margin: 0 1px;
        animation: bouncing 1.4s infinite ease-in-out both;
    }
    
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes bouncing {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }

    /* Avatar status */
    .status-indicator {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: var(--success);
        border: 2px solid var(--surface);
    }
    
    /* Conversation hover effect */
    .conversation-item {
        transition: all 0.2s ease;
    }
    
    .conversation-item:hover {
        background-color: rgba(99, 102, 241, 0.05);
    }
    
    .conversation-item.active {
        background-color: rgba(99, 102, 241, 0.1);
        border-left: 3px solid var(--primary);
    }
    
    /* File attachment preview */
    .file-preview {
        transition: all 0.2s ease;
    }
    
    .file-preview:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    /* Message input */
    .message-input {
        transition: height 0.2s ease;
        min-height: 44px;
        max-height: 120px;
    }
    
    /* Button effects */
    .btn-primary {
        background-color: var(--primary);
        transition: all 0.2s ease;
    }
    
    .btn-primary:hover {
        background-color: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
    }
    
    /* Image modal */
    .image-modal-content {
        transition: all 0.3s ease;
    }
    
    /* New message notification badge */
    .unread-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        min-width: 18px;
        height: 18px;
        border-radius: 9px;
        background-color: var(--danger);
        color: white;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 5px;
    }
    
    /* Empty state animations */
    .empty-state-icon {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); opacity: 0.7; }
        50% { transform: scale(1.05); opacity: 1; }
        100% { transform: scale(1); opacity: 0.7; }
    }

    /* Message delivery status */
    .message-status {
        display: inline-flex;
        align-items: center;
        margin-left: 5px;
    }
    
    .status-delivered {
        color: #9ca3af;
    }
    
    .status-read {
        color: var(--primary);
    }

    /* File type icons */
    .file-type-icon {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
    }
    
    .file-type-pdf {
        background-color: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }
    
    .file-type-doc {
        background-color: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }
    
    .file-type-image {
        background-color: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }
    
    .file-type-default {
        background-color: rgba(100, 116, 139, 0.1);
        color: #64748b;
    }
    
    /* Chat header animations */
    .chat-header {
        transition: box-shadow 0.3s ease;
    }
    
    .chat-header.scrolled {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    /* Mobile responsive styles */
    @media (max-width: 768px) {
        .sidebar {
            position: fixed;
            left: -100%;
            top: 0;
            bottom: 0;
            z-index: 40;
            transition: left 0.3s ease;
        }
        
        .sidebar.open {
            left: 0;
        }
        
        .overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-app flex h-screen bg-gray-50">
    <!-- Sidebar overlay (mobile) -->
    <div id="sidebar-overlay" class="overlay hidden md:hidden"></div>
    
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar bg-white w-full md:w-80 md:relative md:left-0 flex flex-col border-r border-gray-200 z-30">
        <!-- Sidebar header -->
        <div class="p-4 bg-gradient-to-r from-indigo-600 to-indigo-700">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold text-white">Messages</h1>
                    <p class="text-xs text-indigo-100 mt-1">Connected with professionals</p>
                </div>
                <button id="close-sidebar" class="md:hidden text-white focus:outline-none">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <!-- Search and filters -->
        <div class="px-4 py-3 border-b border-gray-200">
            <div class="relative">
                <input type="text" placeholder="Search conversations..." 
                    class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
        </div>
        
        <!-- Conversation List -->
        <div class="flex-1 overflow-y-auto custom-scrollbar" id="conversation-list">
            {% for conversation in conversations %}
            <div class="conversation-item p-3 border-b border-gray-100 cursor-pointer {% if conversation.id == active_conversation.id %}active{% endif %}" 
                data-conversation-id="{{ conversation.id }}">
                <div class="flex items-center">
                    <div class="relative mr-3">
                        {% for participant in conversation.participants.all %}
                            {% if participant != request.user %}
                                <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                                    {% if participant.profile_image %}
                                        <img src="{{ participant.profile_image.url }}" alt="{{ participant.get_full_name }}" class="w-full h-full object-cover">
                                    {% else %}
                                        <span class="text-lg font-medium text-gray-600">{{ participant.get_full_name|slice:":1" }}</span>
                                    {% endif %}
                                </div>
                                <span class="status-indicator"></span>
                            {% endif %}
                        {% endfor %}
                        {% if conversation.unread_count > 0 %}
                        <div class="unread-badge">{{ conversation.unread_count }}</div>
                        {% endif %}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline">
                            <h3 class="font-medium text-gray-900 truncate">
                                {% for participant in conversation.participants.all %}
                                    {% if participant != request.user %}{{ participant.get_full_name }}{% endif %}
                                {% endfor %}
                            </h3>
                            <span class="text-xs text-gray-500 whitespace-nowrap ml-2">{{ conversation.updated_at|timesince }}</span>
                        </div>
                        <p class="text-sm text-gray-500 truncate mt-1">
                            {% if conversation.messages.last %}
                                {% if conversation.messages.last.sender == request.user %}
                                    <span class="text-gray-400">You: </span>{{ conversation.messages.last.content|truncatechars:25 }}
                                {% else %}
                                    {{ conversation.messages.last.content|truncatechars:35 }}
                                {% endif %}
                            {% else %}
                                <span class="text-gray-400 italic">Start a conversation</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="flex flex-col items-center justify-center h-40 p-4">
                <div class="text-gray-400 mb-2 empty-state-icon">
                    <i class="fas fa-comments text-4xl"></i>
                </div>
                <p class="text-gray-500 text-sm text-center">No conversations yet</p>
                <p class="text-gray-400 text-xs text-center mt-1">Start chatting with a professional</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- New Conversation Button -->
        <div class="p-4 border-t border-gray-200">
            <button id="new-conversation-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center btn-primary">
                <i class="fas fa-plus mr-2"></i> New Conversation
            </button>
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col bg-gray-50 overflow-hidden">
        <!-- Chat Header -->
        <div class="chat-header flex items-center justify-between px-4 py-3 bg-white border-b border-gray-200 z-10">
            {% if active_conversation %}
            <div class="flex items-center">
                <button id="open-sidebar" class="md:hidden mr-3 text-gray-600 focus:outline-none">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="relative mr-3">
                    {% for participant in active_conversation.participants.all %}
                        {% if participant != request.user %}
                            <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                                {% if participant.profile_image %}
                                    <img src="{{ participant.profile_image.url }}" alt="{{ participant.get_full_name }}" class="w-full h-full object-cover">
                                {% else %}
                                    <span class="text-base font-medium text-gray-600">{{ participant.get_full_name|slice:":1" }}</span>
                                {% endif %}
                            </div>
                            <span class="status-indicator"></span>
                        {% endif %}
                    {% endfor %}
                </div>
                <div>
                    <h3 class="font-medium text-gray-900">
                        {% for participant in active_conversation.participants.all %}
                            {% if participant != request.user %}{{ participant.get_full_name }}{% endif %}
                        {% endfor %}
                    </h3>
                    <div class="flex items-center">
                        <span class="text-xs text-green-500">Online</span>
                        <div id="typing-indicator" class="text-xs text-gray-500 ml-2 hidden">
                            <div class="typing-indicator flex items-center">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <button class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500 transition-colors duration-200">
                    <i class="fas fa-phone"></i>
                </button>
                <button class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500 transition-colors duration-200">
                    <i class="fas fa-video"></i>
                </button>
                <button class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500 transition-colors duration-200">
                    <i class="fas fa-info-circle"></i>
                </button>
            </div>
            {% else %}
            <div class="flex items-center">
                <button id="open-sidebar" class="md:hidden mr-3 text-gray-600 focus:outline-none">
                    <i class="fas fa-bars"></i>
                </button>
                <h3 class="font-medium text-gray-900">Select a conversation</h3>
            </div>
            {% endif %}
        </div>
        
        <!-- Messages Area -->
        <div id="messages-container" class="flex-1 overflow-y-auto p-4 custom-scrollbar">
            {% if active_conversation %}
                {% for message in active_conversation.messages.all %}
                    <div class="mb-4 message-bubble {% if message.sender == request.user %}flex justify-end{% endif %}" data-message-id="{{ message.id }}">
                        {% if message.sender != request.user %}
                        <div class="mr-2 flex-shrink-0">
                            {% if message.sender.profile_image %}
                                <img src="{{ message.sender.profile_image.url }}" alt="{{ message.sender.get_full_name }}" class="w-8 h-8 rounded-full">
                            {% else %}
                                <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center">
                                    <span class="text-sm font-medium text-gray-600">{{ message.sender.get_full_name|slice:":1" }}</span>
                                </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        <div class="{% if message.sender == request.user %}bg-indigo-500 text-white{% else %}bg-white text-gray-800{% endif %} rounded-lg p-3 shadow-sm max-w-xs md:max-w-md lg:max-w-lg">
                            {% if message.file %}
                                <div class="mb-3 file-preview">
                                    {% if message.file.url|lower|slice:'-4:' == '.pdf' %}
                                        <div class="flex items-center p-2 bg-gray-50 rounded-lg">
                                            <div class="file-type-icon file-type-pdf mr-2">
                                                <i class="fas fa-file-pdf"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-sm font-medium text-gray-900 truncate">{{ message.file_name }}</p>
                                                <p class="text-xs text-gray-500">PDF Document</p>
                                            </div>
                                            <a href="{{ message.file.url }}" target="_blank" class="ml-2 text-indigo-600 hover:text-indigo-700">
                                                <i class="fas fa-download"></i>
                                            </a>
                                        </div>
                                    {% elif message.file.url|lower|slice:'-4:' in '.jpg,.jpeg,.png,.gif' %}
                                        <div class="rounded-lg overflow-hidden cursor-pointer" onclick="openImageModal('{{ message.file.url }}')">
                                            <img src="{{ message.file.url }}" alt="{{ message.file_name }}" class="w-full h-auto max-h-48 object-cover">
                                        </div>
                                    {% else %}
                                        <div class="flex items-center p-2 bg-gray-50 rounded-lg">
                                            <div class="file-type-icon file-type-default mr-2">
                                                <i class="fas fa-file"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-sm font-medium text-gray-900 truncate">{{ message.file_name }}</p>
                                                <p class="text-xs text-gray-500">Document</p>
                                            </div>
                                            <a href="{{ message.file.url }}" target="_blank" class="ml-2 text-indigo-600 hover:text-indigo-700">
                                                <i class="fas fa-download"></i>
                                            </a>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                            <p class="{% if message.sender == request.user %}text-white{% else %}text-gray-800{% endif %}">{{ message.content }}</p>
                            <div class="flex items-center justify-end mt-1 text-xs {% if message.sender == request.user %}text-indigo-100{% else %}text-gray-500{% endif %}">
                                <span>{{ message.sent_at|time:"g:i A" }}</span>
                                {% if message.sender == request.user %}
                                    <span class="message-status">
                                        {% if message.read_by.exists %}
                                            <i class="fas fa-check-double status-read"></i>
                                        {% else %}
                                            <i class="fas fa-check status-delivered"></i>
                                        {% endif %}
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="h-full flex flex-col items-center justify-center">
                        <div class="w-24 h-24 bg-indigo-50 rounded-full flex items-center justify-center mb-4 empty-state-icon">
                            <i class="fas fa-comments text-indigo-300 text-4xl"></i>
                        </div>
                        <h3 class="text-gray-700 font-medium mb-1">No messages yet</h3>
                        <p class="text-gray-500 text-sm text-center">Send a message to start the conversation</p>
                    </div>
                {% endfor %}
            {% else %}
                <div class="h-full flex flex-col items-center justify-center">
                    <div class="w-24 h-24 bg-indigo-50 rounded-full flex items-center justify-center mb-4 empty-state-icon">
                        <i class="fas fa-comments text-indigo-300 text-4xl"></i>
                    </div>
                    <h3 class="text-gray-700 font-medium mb-1">Welcome to Messages</h3>
                    <p class="text-gray-500 text-sm text-center">Select a conversation or start a new one</p>
                    <button id="start-conversation-btn" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg transition-all duration-200 text-sm btn-primary">
                        Start a conversation
                    </button>
                </div>
            {% endif %}
        </div>
        
        <!-- Message Input -->
        {% if active_conversation %}
        <div class="border-t border-gray-200 bg-white p-4">
            <div id="file-preview-container" class="mb-3 hidden">
                <div class="bg-gray-50 rounded-lg p-3 flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="file-type-icon file-type-default mr-3">
                            <i class="fas fa-file" id="file-preview-icon"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900" id="file-preview-name"></p>
                            <p class="text-xs text-gray-500" id="file-preview-size"></p>
                        </div>
                    </div>
                    <button id="remove-file-btn" class="text-red-500 hover:text-red-700 focus:outline-none">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex items-end">
                <div class="flex-none mr-2">
                    <button id="attach-file-btn" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-100 text-gray-500 transition-colors duration-200 focus:outline-none">
                        <i class="fas fa-paperclip"></i>
                        <input type="file" id="file-input" class="hidden" accept="image/*,.pdf,.doc,.docx,.txt">
                    </button>
                </div>
                
                <div class="flex-1 relative">
                    <textarea id="message-input" rows="1" placeholder="Type a message..." 
                        class="message-input w-full pl-4 pr-10 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"></textarea>
                    
                    <button id="send-message-btn" class="absolute right-1 bottom-1 w-9 h-9 rounded-full flex items-center justify-center bg-indigo-600 text-white hover:bg-indigo-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-paper-plane text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Image Modal -->
<div id="image-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex items-center justify-center p-4">
    <div class="relative max-w-4xl max-h-screen">
        <button id="close-modal-btn" class="absolute top-4 right-4 text-white text-xl z-10 w-10 h-10 rounded-full bg-black bg-opacity-50 flex items-center justify-center hover:bg-opacity-70 transition-colors duration-200">
            <i class="fas fa-times"></i>
        </button>
        <img id="modal-image" src="" alt="" class="max-w-full max-h-[90vh] object-contain image-modal-content">
    </div>
</div>

<!-- New Conversation Modal -->
<div id="new-conversation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-lg font-medium text-gray-900">New Conversation</h3>
            <button id="close-modal-icon" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6">
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2" for="new-conversation-user">Select a user to chat with</label>
                <div class="relative">
                    <select id="new-conversation-user" class="w-full border border-gray-300 rounded-lg p-3 pr-10 focus:ring-indigo-500 focus:border-indigo-500 appearance-none bg-white">
                        <option value="">-- Select a user --</option>
                        {% for user in available_users %}
                            <option value="{{ user.id }}">{{ user.get_full_name }} ({{ user.user_type }})</option>
                        {% endfor %}
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
                <p class="mt-2 text-xs text-gray-500">Choose someone from your network to start a conversation with</p>
            </div>
        </div>
        <div class="px-6 py-4 bg-gray-50 flex justify-end">
            <button id="cancel-new-conversation" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mr-3 focus:outline-none">
                Cancel
            </button>
            <button id="confirm-new-conversation" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-medium focus:outline-none btn-primary">
                Start Conversation
            </button>
        </div>
    </div>
</div>

<script>
    // Variables
    let chatSocket;
    let currentConversationId = "{{ active_conversation.id|default:'' }}";
    let typingTimer;
    let isMobileMenuOpen = false;
    const TYPING_DELAY = 1000; // 1 second delay
    
    // Utility Functions
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
    
    function getFileTypeIcon(fileName) {
        const extension = fileName.split('.').pop().toLowerCase();
        
        if (['pdf'].includes(extension)) {
            return {
                icon: 'fa-file-pdf',
                class: 'file-type-pdf'
            };
        } else if (['doc', 'docx'].includes(extension)) {
            return {
                icon: 'fa-file-word',
                class: 'file-type-doc'
            };
        } else if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension)) {
            return {
                icon: 'fa-file-image',
                class: 'file-type-image'
            };
        } else {
            return {
                icon: 'fa-file',
                class: 'file-type-default'
            };
        }
    }
    
    // Initialize WebSocket connection
    function connectWebSocket() {
        if (currentConversationId) {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const wsHost = window.location.host;
            const wsPath = `/ws/chat/${currentConversationId}/?token={{ websocket_token }}`;
            
            chatSocket = new WebSocket(wsPath);
            
            chatSocket.onopen = function(e) {
                console.log('Web chatSocket.onopen = function(e) {
                    console.log('WebSocket connection established');
                    
                    // Mark messages as read when connection is established
                    sendReadReceipt();
                };
                
                chatSocket.onmessage = function(e) {
                    const data = JSON.parse(e.data);
                    handleWebSocketMessage(data);
                };
                
                chatSocket.onclose = function(e) {
                    console.log('WebSocket disconnected, attempting to reconnect...');
                    setTimeout(connectWebSocket, 5000);
                };
                
                chatSocket.onerror = function(err) {
                    console.error('WebSocket error:', err);
                    showErrorNotification('Connection error. Trying to reconnect...');
                };
            }
        }
        
        // Handle incoming WebSocket messages
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'chat_message':
                    appendNewMessage(data);
                    break;
                case 'typing_status':
                    updateTypingIndicator(data);
                    break;
                case 'read_receipt':
                    updateReadReceipts(data);
                    break;
                case 'error':
                    showErrorNotification(data.message);
                    break;
            }
        }
        
        // Append new message to the chat
        function appendNewMessage(data) {
            const messagesContainer = document.getElementById('messages-container');
            const isCurrentUser = data.sender_id == {{ request.user.id }};
            
            // Check if empty state exists and remove it
            const emptyState = messagesContainer.querySelector('.flex.flex-col.items-center.justify-center');
            if (emptyState) {
                emptyState.remove();
            }
            
            const fileHtml = data.has_file ? createFilePreviewHtml(data.file_url, data.file_name) : '';
            
            const messageHtml = `
                <div class="mb-4 message-bubble ${isCurrentUser ? 'flex justify-end' : ''}" data-message-id="${data.message_id}">
                    ${isCurrentUser ? '' : `
                    <div class="mr-2 flex-shrink-0">
                        <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center">
                            <span class="text-sm font-medium text-gray-600">${data.sender_name.charAt(0)}</span>
                        </div>
                    </div>
                    `}
                    <div class="${isCurrentUser ? 'bg-indigo-500 text-white' : 'bg-white text-gray-800'} rounded-lg p-3 shadow-sm max-w-xs md:max-w-md lg:max-w-lg">
                        ${fileHtml}
                        <p class="${isCurrentUser ? 'text-white' : 'text-gray-800'}">${data.message}</p>
                        <div class="flex items-center justify-end mt-1 text-xs ${isCurrentUser ? 'text-indigo-100' : 'text-gray-500'}">
                            <span>${new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                            ${isCurrentUser ? `
                                <span class="message-status ml-1">
                                    <i class="fas fa-check status-delivered"></i>
                                </span>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Animate the new message
            const newMessage = messagesContainer.lastElementChild;
            gsap.from(newMessage, {
                opacity: 0,
                y: 20,
                duration: 0.3,
                ease: "power2.out"
            });
            
            // Send read receipt if not our message
            if (!isCurrentUser) {
                sendReadReceipt(data.message_id);
                
                // Play notification sound if browser tab is not active
                if (document.hidden) {
                    playNotificationSound();
                }
            }
        }
        
        // Create HTML for file preview
        function createFilePreviewHtml(fileUrl, fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            
            if (extension === 'pdf') {
                return `
                    <div class="mb-3 file-preview">
                        <div class="flex items-center p-2 bg-gray-50 rounded-lg">
                            <div class="file-type-icon file-type-pdf mr-2">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 truncate">${fileName}</p>
                                <p class="text-xs text-gray-500">PDF Document</p>
                            </div>
                            <a href="${fileUrl}" target="_blank" class="ml-2 text-indigo-600 hover:text-indigo-700">
                                <i class="fas fa-download"></i>
                            </a>
                        </div>
                    </div>
                `;
            } else if (['jpg', 'jpeg', 'png', 'gif'].some(ext => extension === ext)) {
                return `
                    <div class="mb-3 file-preview">
                        <div class="rounded-lg overflow-hidden cursor-pointer" onclick="openImageModal('${fileUrl}')">
                            <img src="${fileUrl}" alt="${fileName}" class="w-full h-auto max-h-48 object-cover">
                        </div>
                    </div>
                `;
            } else {
                const fileTypeInfo = getFileTypeIcon(fileName);
                return `
                    <div class="mb-3 file-preview">
                        <div class="flex items-center p-2 bg-gray-50 rounded-lg">
                            <div class="file-type-icon ${fileTypeInfo.class} mr-2">
                                <i class="fas ${fileTypeInfo.icon}"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 truncate">${fileName}</p>
                                <p class="text-xs text-gray-500">Document</p>
                            </div>
                            <a href="${fileUrl}" target="_blank" class="ml-2 text-indigo-600 hover:text-indigo-700">
                                <i class="fas fa-download"></i>
                            </a>
                        </div>
                    </div>
                `;
            }
        }
        
        // Update typing indicator
        function updateTypingIndicator(data) {
            const typingIndicator = document.getElementById('typing-indicator');
            
            if (data.user_id != {{ request.user.id }}) {
                if (data.is_typing) {
                    typingIndicator.classList.remove('hidden');
                } else {
                    typingIndicator.classList.add('hidden');
                }
            }
        }
        
        // Update read receipts
        function updateReadReceipts(data) {
            document.querySelectorAll('.message-bubble').forEach(bubble => {
                if (bubble.dataset.messageId == data.message_id) {
                    const statusElement = bubble.querySelector('.message-status i');
                    if (statusElement) {
                        statusElement.className = 'fas fa-check-double status-read';
                    }
                }
            });
        }
        
        // Show error notification
        function showErrorNotification(message) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center';
            toast.innerHTML = `
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            gsap.from(toast, {
                opacity: 0,
                y: 20,
                duration: 0.3,
                ease: "power2.out"
            });
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                gsap.to(toast, {
                    opacity: 0,
                    y: 20,
                    duration: 0.3,
                    ease: "power2.in",
                    onComplete: () => {
                        toast.remove();
                    }
                });
            }, 5000);
        }
        
        // Send message via WebSocket
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const fileInput = document.getElementById('file-input');
            const filePreviewContainer = document.getElementById('file-preview-container');
            
            if ((messageInput.value.trim() === '' && !fileInput.files[0]) || !currentConversationId) return;
            
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                const messageData = {
                    type: "chat_message",
                    message: messageInput.value.trim(),
                    conversation_id: currentConversationId,
                    file: null
                };
                
                if (fileInput.files[0]) {
                    const file = fileInput.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        messageData.file = {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: event.target.result.split(',')[1]
                        };
                        
                        chatSocket.send(JSON.stringify(messageData));
                        
                        // Clear file input
                        fileInput.value = '';
                        filePreviewContainer.classList.add('hidden');
                    };
                    
                    reader.readAsDataURL(file);
                } else {
                    chatSocket.send(JSON.stringify(messageData));
                }
                
                // Clear message input
                messageInput.value = '';
                adjustTextareaHeight(messageInput);
                
                // Clear typing status
                clearTimeout(typingTimer);
                sendTypingStatus(false);
            } else {
                console.error('WebSocket is not connected');
                // Fallback to HTTP request
                sendMessageViaHttp();
            }
        }
        
        // Fallback HTTP message sending
        function sendMessageViaHttp() {
            const messageInput = document.getElementById('message-input');
            const content = messageInput.value.trim();
            
            if (!content || !currentConversationId) return;
            
            fetch('/chat/send/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    conversation_id: currentConversationId,
                    content: content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    messageInput.value = '';
                    adjustTextareaHeight(messageInput);
                    // Reload messages
                    fetch(`/chat/messages/${currentConversationId}/`)
                        .then(response => response.json())
                        .then(data => {
                            updateMessages(data.messages);
                        });
                } else {
                    showErrorNotification(data.message || 'Failed to send message');
                }
            })
            .catch(error => {
                console.error('Error sending message:', error);
                showErrorNotification('Network error. Please check your connection.');
            });
        }
        
        // Update messages from API response
        function updateMessages(messages) {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center">
                        <div class="w-24 h-24 bg-indigo-50 rounded-full flex items-center justify-center mb-4 empty-state-icon">
                            <i class="fas fa-comments text-indigo-300 text-4xl"></i>
                        </div>
                        <h3 class="text-gray-700 font-medium mb-1">No messages yet</h3>
                        <p class="text-gray-500 text-sm text-center">Send a message to start the conversation</p>
                    </div>
                `;
                return;
            }
            
            messages.forEach(message => {
                const isCurrentUser = message.sender_id == {{ request.user.id }};
                const messageHtml = `
                    <div class="mb-4 message-bubble ${isCurrentUser ? 'flex justify-end' : ''}" data-message-id="${message.id}">
                        ${isCurrentUser ? '' : `
                        <div class="mr-2 flex-shrink-0">
                            <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center">
                                <span class="text-sm font-medium text-gray-600">${message.sender_name.charAt(0)}</span>
                            </div>
                        </div>
                        `}
                        <div class="${isCurrentUser ? 'bg-indigo-500 text-white' : 'bg-white text-gray-800'} rounded-lg p-3 shadow-sm max-w-xs md:max-w-md lg:max-w-lg">
                            ${message.has_file ? createFilePreviewHtml(message.file_url, message.file_name) : ''}
                            <p class="${isCurrentUser ? 'text-white' : 'text-gray-800'}">${message.content}</p>
                            <div class="flex items-center justify-end mt-1 text-xs ${isCurrentUser ? 'text-indigo-100' : 'text-gray-500'}">
                                <span>${new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                ${isCurrentUser ? `
                                    <span class="message-status ml-1">
                                        ${message.read_by && message.read_by.length > 0 ? 
                                            '<i class="fas fa-check-double status-read"></i>' : 
                                            '<i class="fas fa-check status-delivered"></i>'}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
            });
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Send typing status
        function sendTypingStatus(isTyping) {
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    type: "typing_status",
                    is_typing: isTyping,
                    conversation_id: currentConversationId
                }));
            }
        }
        
        // Send read receipt
        function sendReadReceipt(messageId) {
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    type: "read_receipt",
                    message_id: messageId || getLastMessageId(),
                    conversation_id: currentConversationId
                }));
            }
        }
        
        // Get last message ID in the conversation
        function getLastMessageId() {
            const messages = document.querySelectorAll('.message-bubble:not(.justify-end)');
            if (messages.length > 0) {
                return messages[messages.length - 1].dataset.messageId;
            }
            return null;
        }
        
        // Adjust textarea height based on content
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
        
        // Open image modal
        function openImageModal(imageUrl) {
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            
            modalImage.src = imageUrl;
            modal.classList.remove('hidden');
            
            // Add animation
            gsap.from(modalImage, {
                scale: 0.8,
                opacity: 0,
                duration: 0.3,
                ease: "power2.out"
            });
        }
        
        // Close image modal
        function closeImageModal() {
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            
            gsap.to(modalImage, {
                scale: 0.8,
                opacity: 0,
                duration: 0.2,
                ease: "power2.in",
                onComplete: () => {
                    modal.classList.add('hidden');
                }
            });
        }
        
        // Create new conversation
        function createNewConversation(userId) {
            if (!userId) return;
            
            fetch('/chat/new/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    user_id: userId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    window.location.href = `/chat/?conversation=${data.conversation_id}`;
                } else {
                    showErrorNotification(data.message || 'Failed to create conversation');
                }
            })
            .catch(error => {
                console.error('Error creating conversation:', error);
                showErrorNotification('Network error. Please check your connection.');
            });
        }
        
        // Mobile menu functions
        function openMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            sidebar.classList.add('open');
            sidebar.style.left = '0';
            overlay.classList.remove('hidden');
            
            // Animate overlay
            gsap.to(overlay, {
                opacity: 1,
                duration: 0.2
            });
            
            // Animate sidebar
            gsap.from(sidebar, {
                x: -100,
                duration: 0.3,
                ease: "power2.out"
            });
            
            isMobileMenuOpen = true;
        }
        
        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            // Animate sidebar
            gsap.to(sidebar, {
                x: -100,
                duration: 0.3,
                ease: "power2.in",
                onComplete: () => {
                    sidebar.classList.remove('open');
                    sidebar.style.left = '-100%';
                    sidebar.style.transform = '';
                }
            });
            
            // Animate overlay
            gsap.to(overlay, {
                opacity: 0,
                duration: 0.2,
                onComplete: () => {
                    overlay.classList.add('hidden');
                }
            });
            
            isMobileMenuOpen = false;
        }
        
        // Play notification sound
        function playNotificationSound() {
            const audio = new Audio('/static/sounds/notification.mp3');
            audio.volume = 0.5;
            audio.play().catch(e => console.log('Error playing notification sound:', e));
        }
        
        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Connect to WebSocket
            connectWebSocket();
            
            // Message input events
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    adjustTextareaHeight(this);
                    
                    // Send typing status
                    clearTimeout(typingTimer);
                    sendTypingStatus(true);
                    
                    typingTimer = setTimeout(() => {
                        sendTypingStatus(false);
                    }, TYPING_DELAY);
                });
                
                messageInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            // Send button
            const sendButton = document.getElementById('send-message-btn');
            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }
            
            // File upload
            const fileInput = document.getElementById('file-input');
            const attachButton = document.getElementById('attach-file-btn');
            const removeFileButton = document.getElementById('remove-file-btn');
            
            if (attachButton) {
                attachButton.addEventListener('click', () => {
                    fileInput.click();
                });
            }
            
            if (fileInput) {
                fileInput.addEventListener('change', function() {
                    if (this.files.length > 0) {
                        const file = this.files[0];
                        const previewContainer = document.getElementById('file-preview-container');
                        const previewName = document.getElementById('file-preview-name');
                        const previewSize = document.getElementById('file-preview-size');
                        const previewIcon = document.getElementById('file-preview-icon');
                        
                        previewName.textContent = file.name;
                        previewSize.textContent = formatFileSize(file.size);
                        
                        const fileTypeInfo = getFileTypeIcon(file.name);
                        previewIcon.className = `fas ${fileTypeInfo.icon}`;
                        previewIcon.parentElement.className = `file-type-icon ${fileTypeInfo.class} mr-3`;
                        
                        previewContainer.classList.remove('hidden');
                        
                        // Animate
                        gsap.from(previewContainer, {
                            y: 10,
                            opacity: 0,
                            duration: 0.3
                        });
                    }
                });
            }
            
            if (removeFileButton) {
                removeFileButton.addEventListener('click', function() {
                    fileInput.value = '';
                    document.getElementById('file-preview-container').classList.add('hidden');
                });
            }
            
            // Mobile menu
            const openSidebarButton = document.getElementById('open-sidebar');
            const closeSidebarButton = document.getElementById('close-sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            
            if (openSidebarButton) {
                openSidebarButton.addEventListener('click', openMobileMenu);
            }
            
            if (closeSidebarButton) {
                closeSidebarButton.addEventListener('click', closeMobileMenu);
            }
            
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', closeMobileMenu);
            }
            
            // Image modal
            const closeModalButton = document.getElementById('close-modal-btn');
            const imageModal = document.getElementById('image-modal');
            
            if (closeModalButton) {
                closeModalButton.addEventListener('click', closeImageModal);
            }
            
            if (imageModal) {
                imageModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeImageModal();
                    }
                });
            }
            
            // New conversation modal
            const newConversationButton = document.getElementById('new-conversation-btn');
            const cancelNewConversationButton = document.getElementById('cancel-new-conversation');
            const confirmNewConversationButton = document.getElementById('confirm-new-conversation');
            const closeModalIconButton = document.getElementById('close-modal-icon');
            const newConversationModal = document.getElementById('new-conversation-modal');
            
            if (newConversationButton) {
                newConversationButton.addEventListener('click', function() {
                    newConversationModal.classList.remove('hidden');
                    gsap.from(newConversationModal.querySelector('.bg-white'), {
                        scale: 0.9,
                        opacity: 0,
                        duration: 0.3
                    });
                });
            }
            
            if (cancelNewConversationButton) {
                cancelNewConversationButton.addEventListener('click', function() {
                    gsap.to(newConversationModal.querySelector('.bg-white'), {
                        scale: 0.9,
                        opacity: 0,
                        duration: 0.2,
                        onComplete: () => {
                            newConversationModal.classList.add('hidden');
                        }
                    });
                });
            }
            
            if (closeModalIconButton) {
                closeModalIconButton.addEventListener('click', function() {
                    gsap.to(newConversationModal.querySelector('.bg-white'), {
                        scale: 0.9,
                        opacity: 0,
                        duration: 0.2,
                        onComplete: () => {
                            newConversationModal.classList.add('hidden');
                        }
                    });
                });
            }
            
            if (confirmNewConversationButton) {
                confirmNewConversationButton.addEventListener('click', function() {
                    const userId = document.getElementById('new-conversation-user').value;
                    if (userId) {
                        createNewConversation(userId);
                    }
                });
            }
            
            // Start conversation button (empty state)
            const startConversationButton = document.getElementById('start-conversation-btn');
            if (startConversationButton) {
                startConversationButton.addEventListener('click', function() {
                    newConversationModal.classList.remove('hidden');
                    gsap.from(newConversationModal.querySelector('.bg-white'), {
                        scale: 0.9,
                        opacity: 0,
                        duration: 0.3
                    });
                });
            }
            
            // Conversation list click events
            const conversationItems = document.querySelectorAll('.conversation-item');
            conversationItems.forEach(item => {
                item.addEventListener('click', function() {
                    const conversationId = this.dataset.conversationId;
                    window.location.href = `/chat/?conversation=${conversationId}`;
                });
            });
            
            // Scroll messages to bottom
            const messagesContainer = document.getElementById('messages-container');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Mark messages as read when scrolled to bottom
                messagesContainer.addEventListener('scroll', function() {
                    if (this.scrollTop + this.clientHeight >= this.scrollHeight - 50) {
                        sendReadReceipt();
                    }
                });
            }
            
            // Handle header shadow on scroll
            const chatHeader = document.querySelector('.chat-header');
            if (messagesContainer && chatHeader) {
                messagesContainer.addEventListener('scroll', function() {
                    if (this.scrollTop > 10) {
                        chatHeader.classList.add('scrolled');
                    } else {
                        chatHeader.classList.remove('scrolled');
                    }
                });
            }
            
            // Handle visibility change to mark messages as read
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && currentConversationId) {
                    sendReadReceipt();
                }
            });
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth >= 768 && isMobileMenuOpen) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                
                sidebar.classList.remove('open');
                sidebar.style.left = '';
                sidebar.style.transform = '';
                overlay.classList.add('hidden');
                overlay.style.opacity = '';
                
                isMobileMenuOpen = false;
            }
        });
    </script>
    {% endblock %}
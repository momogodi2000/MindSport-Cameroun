{% extends 'Dashboards/Layout/chat_base.html' %}
{% load static %}

{% block head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/gsap@3.11.4/dist/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
<style>
    .message-bubble {
        transition: all 0.3s ease;
        transform-origin: left bottom;
    }
    .message-bubble:hover {
        transform: scale(1.02);
    }
    .typing-indicator span {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #4b5563;
        margin: 0 2px;
        animation: bounce 1.4s infinite ease-in-out both;
    }
    .typing-indicator span:nth-child(1) {
        animation-delay: -0.32s;
    }
    .typing-indicator span:nth-child(2) {
        animation-delay: -0.16s;
    }
    @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }
    .glow-on-hover {
        transition: box-shadow 0.3s ease;
    }
    .glow-on-hover:hover {
        box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
    }
    .file-preview {
        transition: all 0.3s ease;
    }
    .file-preview:hover {
        transform: translateY(-3px);
    }
    #particles-js {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        z-index: 0;
        pointer-events: none;
    }
    .chat-container {
        position: relative;
        z-index: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100">
    <!-- Sidebar -->
    <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
        <!-- Header -->
        <div class="p-4 border-b border-gray-200 bg-indigo-600 text-white">
            <h2 class="text-xl font-bold">Messages</h2>
            <p class="text-sm text-indigo-100">Connected with professionals</p>
        </div>
        
        <!-- Search -->
        <div class="p-3 border-b border-gray-200">
            <div class="relative">
                <input type="text" placeholder="Search conversations..." 
                    class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
        </div>
        
        <!-- Conversation List -->
        <div class="flex-1 overflow-y-auto" id="conversation-list">
            {% for conversation in conversations %}
            <div class="p-4 border-b border-gray-200 hover:bg-gray-50 cursor-pointer transition-colors duration-200 conversation-item"
                data-conversation-id="{{ conversation.id }}">
                <div class="flex items-center">
                    <div class="relative">
                        <img src="{% static 'images/avatar-placeholder.png' %}" alt="User" class="w-10 h-10 rounded-full">
                        <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></span>
                    </div>
                    <div class="ml-3 flex-1">
                        <div class="flex justify-between items-center">
                            <h3 class="font-medium text-gray-900">
                                {% for participant in conversation.participants.all %}
                                    {% if participant != request.user %}{{ participant.get_full_name }}{% endif %}
                                {% endfor %}
                            </h3>
                            <span class="text-xs text-gray-500">{{ conversation.updated_at|timesince }} ago</span>
                        </div>
                        <p class="text-sm text-gray-500 truncate">
                            {% if conversation.messages.last %}
                                {{ conversation.messages.last.content|truncatechars:30 }}
                            {% else %}
                                No messages yet
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="p-4 text-center text-gray-500">
                No conversations yet. Start a new one!
            </div>
            {% endfor %}
        </div>
        
        <!-- New Conversation Button -->
        <div class="p-4 border-t border-gray-200">
            <button id="new-conversation-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center glow-on-hover">
                <i class="fas fa-plus mr-2"></i> New Conversation
            </button>
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col">
        <!-- Chat Header -->
        <div class="p-4 border-b border-gray-200 bg-white flex items-center justify-between">
            <div class="flex items-center">
                <img src="{% static 'images/avatar-placeholder.png' %}" alt="User" class="w-10 h-10 rounded-full">
                <div class="ml-3">
                    <h3 id="chat-partner-name" class="font-medium text-gray-900">
                        {% if active_conversation %}
                            {% for participant in active_conversation.participants.all %}
                                {% if participant != request.user %}{{ participant.get_full_name }}{% endif %}
                            {% endfor %}
                        {% else %}
                            Select a conversation
                        {% endif %}
                    </h3>
                    <div id="typing-indicator" class="text-xs text-gray-500 hidden">
                        <div class="typing-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                            <span class="ml-1">typing...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <button class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-phone"></i>
                </button>
                <button class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-video"></i>
                </button>
                <button class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>
        </div>
        
        <!-- Messages Container -->
        <div id="messages-container" class="flex-1 overflow-y-auto p-4 bg-gray-50" style="background-image: url('{% static 'images/chat-bg-pattern.png' %}'); background-size: cover;">
            <div id="particles-js"></div>
            <div class="chat-container max-w-3xl mx-auto">
                {% if active_conversation %}
                    {% for message in active_conversation.messages.all %}
                        <div class="mb-4 message-bubble {% if message.sender == request.user %}text-right{% endif %}">
                            <div class="{% if message.sender == request.user %}bg-indigo-100{% else %}bg-white{% endif %} rounded-lg p-3 inline-block max-w-xs md:max-w-md lg:max-w-lg shadow-sm">
                                {% if message.file %}
                                <div class="mb-2 file-preview">
                                    {% if message.file.url|lower|slice:'-4:' == '.pdf' %}
                                        <div class="bg-gray-100 p-2 rounded-lg">
                                            <i class="fas fa-file-pdf text-red-500 mr-2"></i>
                                            <a href="{{ message.file.url }}" target="_blank" class="text-blue-600 hover:underline">{{ message.file_name }}</a>
                                        </div>
                                    {% elif message.file.url|lower|slice:'-4:' in '.jpg,.jpeg,.png,.gif' %}
                                        <img src="{{ message.file.url }}" alt="{{ message.file_name }}" class="rounded-lg max-h-48 cursor-pointer" onclick="openImageModal('{{ message.file.url }}')">
                                    {% else %}
                                        <div class="bg-gray-100 p-2 rounded-lg">
                                            <i class="fas fa-file text-gray-500 mr-2"></i>
                                            <a href="{{ message.file.url }}" target="_blank" class="text-blue-600 hover:underline">{{ message.file_name }}</a>
                                        </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                <p class="text-gray-800">{{ message.content }}</p>
                                <div class="text-xs mt-1 text-gray-500 flex {% if message.sender == request.user %}justify-end{% else %}justify-start{% endif %} items-center">
                                    <span>{{ message.sent_at|time }}</span>
                                    {% if message.sender == request.user %}
                                        <span class="ml-1 read-receipt">
                                            {% if message.read_by.exists %}
                                                <i class="fas fa-check-double text-blue-500"></i>
                                            {% else %}
                                                <i class="fas fa-check text-gray-400"></i>
                                            {% endif %}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="text-center text-gray-500 py-10">
                            <i class="fas fa-comments text-4xl mb-2"></i>
                            <p>No messages yet. Start the conversation!</p>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <div class="w-32 h-32 mx-auto mb-4">
                                <!-- 3D Animated Chat Icon -->
                                <div id="3d-chat-icon" class="w-full h-full"></div>
                            </div>
                            <h3 class="text-xl font-medium text-gray-700 mb-2">Select a conversation</h3>
                            <p class="text-gray-500">Choose an existing chat or start a new one</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Message Input -->
        <div class="p-4 border-t border-gray-200 bg-white">
            <div id="file-preview-container" class="mb-2 hidden">
                <div class="bg-gray-100 rounded-lg p-2 flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-file text-gray-500 mr-2"></i>
                        <span id="file-preview-name" class="text-sm"></span>
                    </div>
                    <button id="remove-file-btn" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex items-center">
                <button id="attach-file-btn" class="p-2 text-gray-500 hover:text-gray-700 mr-2">
                    <i class="fas fa-paperclip"></i>
                    <input type="file" id="file-input" class="hidden" accept="image/*,.pdf,.doc,.docx,.txt">
                </button>
                
                <div class="flex-1 relative">
                    <textarea id="message-input" rows="1" placeholder="Type a message..." 
                        class="w-full pl-4 pr-12 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"
                        style="min-height: 44px; max-height: 120px;"></textarea>
                    
                    <div class="absolute right-2 bottom-2 flex items-center">
                        <button id="send-message-btn" class="p-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-colors duration-200">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="image-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center">
    <div class="relative max-w-4xl max-h-screen">
        <button id="close-modal-btn" class="absolute top-4 right-4 text-white text-2xl z-10">
            <i class="fas fa-times"></i>
        </button>
        <img id="modal-image" src="" alt="" class="max-w-full max-h-screen">
    </div>
</div>

<!-- New Conversation Modal -->
<div id="new-conversation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
        <div class="p-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">New Conversation</h3>
        </div>
        <div class="p-4">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Select User</label>
                <select id="new-conversation-user" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">-- Select a user --</option>
                    {% for user in available_users %}
                        <option value="{{ user.id }}">{{ user.get_full_name }} ({{ user.user_type }})</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="p-4 border-t border-gray-200 flex justify-end">
            <button id="cancel-new-conversation" class="px-4 py-2 text-gray-600 hover:text-gray-800 mr-2">
                Cancel
            </button>
            <button id="confirm-new-conversation" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                Start Conversation
            </button>
        </div>
    </div>
</div>

<script>
    // WebSocket connection setup
    let chatSocket;
    let currentConversationId = "{{ active_conversation.id|default:'' }}";
    let typingTimer;
    const TYPING_DELAY = 1000; // 1 second delay
    
    // Initialize WebSocket connection
    function connectWebSocket() {
        if (currentConversationId) {
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const host = window.location.host;
            const path = `/ws/chat/${currentConversationId}/`;
            
            chatSocket = new WebSocket(protocol + host + path);
            
            chatSocket.onopen = function(e) {
                console.log('WebSocket connection established');
            };
            
            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                handleWebSocketMessage(data);
            };
            
            chatSocket.onclose = function(e) {
                console.log('WebSocket disconnected, attempting to reconnect...');
                setTimeout(connectWebSocket, 5000);
            };
            
            chatSocket.onerror = function(err) {
                console.error('WebSocket error:', err);
            };
        }
    }
    
    // Handle incoming WebSocket messages
    function handleWebSocketMessage(data) {
        switch(data.type) {
            case 'chat_message':
                appendNewMessage(data);
                break;
            case 'typing_status':
                updateTypingIndicator(data);
                break;
            case 'read_receipt':
                updateReadReceipts(data);
                break;
            case 'conversation_history':
                renderConversationHistory(data.history);
                break;
            case 'error':
                showErrorNotification(data.message);
                break;
        }
    }
    
    // Append new message to the chat
    function appendNewMessage(data) {
        const messagesContainer = document.getElementById('messages-container');
        const isCurrentUser = data.sender_id === {{ request.user.id }};
        
        const messageHtml = `
            <div class="mb-4 message-bubble ${isCurrentUser ? 'text-right' : ''}">
                <div class="${isCurrentUser ? 'bg-indigo-100' : 'bg-white'} rounded-lg p-3 inline-block max-w-xs md:max-w-md lg:max-w-lg shadow-sm">
                    ${data.has_file ? `
                        <div class="mb-2 file-preview">
                            ${data.file_url.endsWith('.pdf') ? `
                                <div class="bg-gray-100 p-2 rounded-lg">
                                    <i class="fas fa-file-pdf text-red-500 mr-2"></i>
                                    <a href="${data.file_url}" target="_blank" class="text-blue-600 hover:underline">${data.file_name}</a>
                                </div>
                            ` : (['.jpg', '.jpeg', '.png', '.gif'].some(ext => data.file_url.endsWith(ext)) ? `
                                <img src="${data.file_url}" alt="${data.file_name}" class="rounded-lg max-h-48 cursor-pointer" onclick="openImageModal('${data.file_url}')">
                            ` : `
                                <div class="bg-gray-100 p-2 rounded-lg">
                                    <i class="fas fa-file text-gray-500 mr-2"></i>
                                    <a href="${data.file_url}" target="_blank" class="text-blue-600 hover:underline">${data.file_name}</a>
                                </div>
                            `}
                        </div>
                    ` : ''}
                    <p class="text-gray-800">${data.message}</p>
                    <div class="text-xs mt-1 text-gray-500 flex ${isCurrentUser ? 'justify-end' : 'justify-start'} items-center">
                        <span>${new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        ${isCurrentUser ? `
                            <span class="ml-1 read-receipt">
                                <i class="fas fa-check text-gray-400"></i>
                            </span>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
        
        messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Animate the new message
        const newMessage = messagesContainer.lastElementChild;
        gsap.from(newMessage, {
            opacity: 0,
            y: 20,
            duration: 0.3,
            ease: "power2.out"
        });
    }
    
    // Update typing indicator
    function updateTypingIndicator(data) {
        const typingIndicator = document.getElementById('typing-indicator');
        const chatPartnerName = document.getElementById('chat-partner-name');
        
        if (data.user_id !== {{ request.user.id }}) {
            if (data.is_typing) {
                typingIndicator.classList.remove('hidden');
                chatPartnerName.textContent = data.user_name;
            } else {
                typingIndicator.classList.add('hidden');
            }
        }
    }
    
    // Update read receipts
    function updateReadReceipts(data) {
        document.querySelectorAll('.read-receipt').forEach(receipt => {
            const messageId = receipt.closest('.message-bubble').dataset.messageId;
            if (messageId === data.message_id) {
                receipt.innerHTML = '<i class="fas fa-check-double text-blue-500"></i>';
            }
        });
    }
    
    // Render conversation history
    function renderConversationHistory(history) {
        const messagesContainer = document.getElementById('messages-container');
        messagesContainer.innerHTML = '';
        
        history.forEach(message => {
            const isCurrentUser = message.sender_id === {{ request.user.id }};
            
            const messageHtml = `
                <div class="mb-4 message-bubble ${isCurrentUser ? 'text-right' : ''}">
                    <div class="${isCurrentUser ? 'bg-indigo-100' : 'bg-white'} rounded-lg p-3 inline-block max-w-xs md:max-w-md lg:max-w-lg shadow-sm">
                        ${message.has_file ? `
                            <div class="mb-2 file-preview">
                                ${message.file_url.endsWith('.pdf') ? `
                                    <div class="bg-gray-100 p-2 rounded-lg">
                                        <i class="fas fa-file-pdf text-red-500 mr-2"></i>
                                        <a href="${message.file_url}" target="_blank" class="text-blue-600 hover:underline">${message.file_name}</a>
                                    </div>
                                ` : (['.jpg', '.jpeg', '.png', '.gif'].some(ext => message.file_url.endsWith(ext)) ? `
                                    <img src="${message.file_url}" alt="${message.file_name}" class="rounded-lg max-h-48 cursor-pointer" onclick="openImageModal('${message.file_url}')">
                                ` : `
                                    <div class="bg-gray-100 p-2 rounded-lg">
                                        <i class="fas fa-file text-gray-500 mr-2"></i>
                                        <a href="${message.file_url}" target="_blank" class="text-blue-600 hover:underline">${message.file_name}</a>
                                    </div>
                                `)}
                            </div>
                        ` : ''}
                        <p class="text-gray-800">${message.message}</p>
                        <div class="text-xs mt-1 text-gray-500 flex ${isCurrentUser ? 'justify-end' : 'justify-start'} items-center">
                            <span>${new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                            ${isCurrentUser ? `
                                <span class="ml-1 read-receipt">
                                    ${message.read_by.includes({{ request.user.id }}) ? 
                                        '<i class="fas fa-check-double text-blue-500"></i>' : 
                                        '<i class="fas fa-check text-gray-400"></i>'}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
        });
        
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // Show error notification
    function showErrorNotification(message) {
        // Implement a nice toast notification
        console.error('Error:', message);
    }
    
    // Send message via WebSocket
    function sendMessage() {
        const messageInput = document.getElementById('message-input');
        const fileInput = document.getElementById('file-input');
        const filePreviewContainer = document.getElementById('file-preview-container');
        
        if (messageInput.value.trim() === '' && !fileInput.files[0]) return;
        
        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            const messageData = {
                type: "chat_message",
                message: messageInput.value.trim(),
                file: null
            };
            
            if (fileInput.files[0]) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    const fileData = {
                        name: file.name,
                        type: file.type,
                        data: event.target.result.split(',')[1]
                    };
                    
                    messageData.file = `data:${file.type};base64,${fileData.data}`;
                    chatSocket.send(JSON.stringify(messageData));
                    
                    // Clear file input
                    fileInput.value = '';
                    filePreviewContainer.classList.add('hidden');
                };
                
                reader.readAsDataURL(file);
            } else {
                chatSocket.send(JSON.stringify(messageData));
            }
            
            // Clear message input
            messageInput.value = '';
            adjustTextareaHeight(messageInput);
            
            // Send read receipt for the last message
            sendReadReceipt();
        } else {
            console.error('WebSocket is not connected');
        }
    }
    
    // Send typing status
    function sendTypingStatus(isTyping) {
        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                type: "typing_status",
                is_typing: isTyping
            }));
        }
    }
    
    // Send read receipt
    function sendReadReceipt() {
        const messagesContainer = document.getElementById('messages-container');
        const lastMessage = messagesContainer.querySelector('.message-bubble:not(.text-right) .read-receipt');
        
        if (lastMessage && !lastMessage.querySelector('.fa-check-double')) {
            const messageId = lastMessage.closest('.message-bubble').dataset.messageId;
            
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    type: "read_receipt",
                    message_id: messageId
                }));
            }
        }
    }
    
    // Adjust textarea height based on content
    function adjustTextareaHeight(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = (textarea.scrollHeight) + 'px';
    }
    
    // Open image modal
    function openImageModal(imageUrl) {
        const modal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        
        modalImage.src = imageUrl;
        modal.classList.remove('hidden');
        
        // Add animation
        gsap.from(modalImage, {
            scale: 0.8,
            opacity: 0,
            duration: 0.3,
            ease: "power2.out"
        });
    }
    
    // Close image modal
    function closeImageModal() {
        const modal = document.getElementById('image-modal');
        modal.classList.add('hidden');
    }
    
    // Initialize 3D chat icon
    function init3DChatIcon() {
        const container = document.getElementById('3d-chat-icon');
        
        // Set up Three.js scene
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(container.offsetWidth, container.offsetHeight);
        container.appendChild(renderer.domElement);
        
        // Create chat bubble geometry
        const bubbleGeometry = new THREE.SphereGeometry(1, 32, 32);
        const bubbleMaterial = new THREE.MeshPhongMaterial({ 
            color: 0x6366f1,
            specular: 0xffffff,
            shininess: 50
        });
        const bubble = new THREE.Mesh(bubbleGeometry, bubbleMaterial);
        scene.add(bubble);
        
        // Create text geometry
        const textGeometry = new THREE.TextGeometry('...', {
            size: 0.5,
            height: 0.1,
            curveSegments: 12,
            bevelEnabled: false
        });
        const textMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });
        const text = new THREE.Mesh(textGeometry, textMaterial);
        text.position.set(-0.5, 0, 1.1);
        scene.add(text);
        
        // Add lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(1, 1, 1);
        scene.add(directionalLight);
        
        // Position camera
        camera.position.z = 3;
        
        // Add controls
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableZoom = false;
        controls.enablePan = false;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 1;
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        
        animate();
        
        // Handle resize
        window.addEventListener('resize', () => {
            camera.aspect = 1;
            camera.updateProjectionMatrix();
            renderer.setSize(container.offsetWidth, container.offsetHeight);
        });
    }
    
    // Initialize particles
    function initParticles() {
        // This would be replaced with actual particles.js implementation
        console.log('Particles initialized');
    }
    
    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize WebSocket
        connectWebSocket();
        
        // Initialize 3D elements
        if (!currentConversationId) {
            init3DChatIcon();
        }
        
        // Initialize particles
        initParticles();
        
        // Message input events
        const messageInput = document.getElementById('message-input');
        messageInput.addEventListener('input', function() {
            adjustTextareaHeight(this);
            
            // Send typing status
            clearTimeout(typingTimer);
            sendTypingStatus(true);
            
            typingTimer = setTimeout(() => {
                sendTypingStatus(false);
            }, TYPING_DELAY);
        });
        
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Send button click
        document.getElementById('send-message-btn').addEventListener('click', sendMessage);
        
        // File attachment
        document.getElementById('attach-file-btn').addEventListener('click', function() {
            document.getElementById('file-input').click();
        });
        
        document.getElementById('file-input').addEventListener('change', function() {
            if (this.files[0]) {
                const filePreviewContainer = document.getElementById('file-preview-container');
                const filePreviewName = document.getElementById('file-preview-name');
                
                filePreviewName.textContent = this.files[0].name;
                filePreviewContainer.classList.remove('hidden');
                
                // Animate the preview
                gsap.from(filePreviewContainer, {
                    opacity: 0,
                    y: 10,
                    duration: 0.3,
                    ease: "power2.out"
                });
            }
        });
        
        document.getElementById('remove-file-btn').addEventListener('click', function() {
            document.getElementById('file-input').value = '';
            document.getElementById('file-preview-container').classList.add('hidden');
        });
        
        // Image modal
        document.getElementById('close-modal-btn').addEventListener('click', closeImageModal);
        document.getElementById('image-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });
        
        // New conversation modal
        document.getElementById('new-conversation-btn').addEventListener('click', function() {
            document.getElementById('new-conversation-modal').classList.remove('hidden');
        });
        
        document.getElementById('cancel-new-conversation').addEventListener('click', function() {
            document.getElementById('new-conversation-modal').classList.add('hidden');
        });
        
        document.getElementById('confirm-new-conversation').addEventListener('click', function() {
            const userId = document.getElementById('new-conversation-user').value;
            if (userId) {
                // In a real implementation, you would make an AJAX call to create the conversation
                console.log('Starting new conversation with user ID:', userId);
                document.getElementById('new-conversation-modal').classList.add('hidden');
                
                // For demo purposes, we'll just show a success message
                alert('New conversation created! In a real app, this would redirect to the new conversation.');
            }
        });
        
        // Conversation item clicks
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.addEventListener('click', function() {
                const conversationId = this.dataset.conversationId;
                // In a real implementation, you would navigate to the conversation
                console.log('Switching to conversation ID:', conversationId);
                
                // For demo purposes, we'll just update the UI
                currentConversationId = conversationId;
                document.getElementById('chat-partner-name').textContent = 
                    this.querySelector('h3').textContent;
                
                // Close WebSocket and reconnect for new conversation
                if (chatSocket) {
                    chatSocket.close();
                }
                connectWebSocket();
            });
        });
        
        // Scroll to bottom of messages container
        const messagesContainer = document.getElementById('messages-container');
        if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Send read receipt when scrolling to bottom
            messagesContainer.addEventListener('scroll', function() {
                if (this.scrollTop + this.clientHeight >= this.scrollHeight - 50) {
                    sendReadReceipt();
                }
            });
        }
    });
</script>
{% endblock %}
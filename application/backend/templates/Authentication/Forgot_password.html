{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password | Mental Health Platform Cameroon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.3/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        @keyframes slideIn {
            0% {
                transform: translateY(20px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            0% {
                opacity: 0;
            }
            100% {
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(186, 230, 253, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(186, 230, 253, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(186, 230, 253, 0);
            }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        .bg-wave {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%23bae6fd' fill-opacity='0.6' d='M0,256L48,240C96,224,192,192,288,181.3C384,171,480,181,576,176C672,171,768,149,864,149.3C960,149,1056,171,1152,176C1248,181,1344,171,1392,165.3L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-size: cover;
            background-position: center bottom;
        }
        
        .bg-pattern {
            background-color: #f0f9ff;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%2388ccf2' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .code-input {
            letter-spacing: 0.5em;
            text-align: center;
            font-weight: bold;
        }
        
        /* Floating label styles */
        .floating-label {
            position: relative;
        }
        
        .floating-label input:focus + label,
        .floating-label input:not(:placeholder-shown) + label {
            transform: translateY(-2.2rem) scale(0.85);
            color: #0284c7;
            padding: 0 0.2rem;
            background-color: white;
        }
        
        .floating-label label {
            position: absolute;
            left: 1rem;
            top: 0.95rem;
            transform-origin: left top;
            cursor: text;
            transition: all 0.2s ease-out;
        }

        [x-cloak] { display: none !important; }
    </style>
</head>

<body class="bg-gray-50 font-sans min-h-screen">
    <div x-data="passwordReset()" class="min-h-screen flex flex-col">
        <!-- Header with subtle gradient -->
        <header class="bg-gradient-to-r from-sky-50 to-sky-100 shadow-sm py-4">
            <div class="container mx-auto px-4 md:px-6 flex justify-between items-center">
                <a href="{% url 'homepage' %}" class="flex items-center space-x-2">
                    <div class="h-10 w-10 bg-sky-500 rounded-lg flex items-center justify-center shadow-sm">
                        <i class="fas fa-brain text-white text-xl"></i>
                    </div>
                    <span class="text-sky-600 text-xl font-bold">Mental Health Platform</span>
                </a>
                <a href="{% url 'login' %}" class="flex items-center text-sky-600 hover:text-sky-800 transition-colors bg-white py-2 px-4 rounded-lg shadow-sm hover:shadow">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Login
                </a>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow flex items-center justify-center px-4 py-12 relative bg-pattern">
            <div class="absolute inset-0 bg-wave bg-no-repeat bg-bottom"></div>
            
            <!-- Card Container with improved shadow and border -->
            <div class="bg-white rounded-xl shadow-xl overflow-hidden w-full max-w-md z-10 slide-in border border-sky-100">
                <!-- Card Header -->
                <div class="bg-gradient-to-r from-sky-100 to-blue-100 p-8 text-center border-b border-sky-200">
                    <div class="w-20 h-20 bg-gradient-to-br from-sky-400 to-sky-600 text-white rounded-full flex items-center justify-center mx-auto mb-4 pulse shadow-lg">
                        <i class="fas fa-lock-open text-3xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">Reset Your Password</h1>
                    <p class="text-gray-600">We'll help you get back into your account</p>
                </div>
                
                <!-- Progress Bar -->
                <div class="bg-gray-100 h-2 w-full">
                    <div 
                        class="bg-sky-500 h-2 transition-all duration-500"
                        :style="{
                            width: step === 'request' ? '33%' : step === 'verify' ? '66%' : '100%'
                        }"
                    ></div>
                </div>
                
                <!-- Step 1: Request Reset -->
                <div x-show="step === 'request'" class="p-8 fade-in">
                    <div class="mb-6 bg-sky-50 border-l-4 border-sky-500 p-4 rounded-r-lg">
                        <h2 class="font-semibold text-sky-800">Step 1: Verify Email</h2>
                        <p class="text-gray-600 text-sm mt-1">Enter your email address and we'll send you a verification code.</p>
                    </div>
                    
                    <form @submit.prevent="requestReset" class="space-y-6" action="{% url 'forgot_password' %}" method="POST">
                        {% csrf_token %}
                        <div class="floating-label">
                            <input 
                                type="email" 
                                id="email" 
                                name="email"
                                x-model="email" 
                                class="w-full border border-gray-300 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-all pl-10 placeholder-transparent"
                                placeholder="Email Address"
                                required
                            >
                            <label for="email" class="text-gray-500 text-sm transition-all">Email Address</label>
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-envelope text-gray-400"></i>
                            </div>
                        </div>
                        <div x-show="emailError" class="text-red-500 text-sm -mt-4" x-text="emailError"></div>
                        
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-info-circle mr-1 text-sky-500"></i>
                            Make sure to use the email address associated with your account.
                        </div>
                        
                        <button 
                            type="submit" 
                            class="w-full bg-gradient-to-r from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 text-white font-medium py-3 px-4 rounded-lg transition-all focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 shadow-md hover:shadow-lg hover:-translate-y-0.5"
                            :disabled="loading"
                        >
                            <span x-show="!loading">Send Reset Code</span>
                            <span x-show="loading" class="flex items-center justify-center">
                                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Sending Code...
                            </span>
                        </button>
                        
                        <div class="text-center text-gray-500 text-sm border-t border-gray-100 pt-4 mt-4">
                            <p>Remember your password? <a href="{% url 'login' %}" class="text-sky-600 hover:underline">Sign in</a></p>
                        </div>
                    </form>
                </div>
                
                <!-- Step 2: Verify Code and Reset -->
                <div x-show="step === 'verify'" class="p-8 fade-in" x-cloak>
                    <div class="mb-6 bg-sky-50 border-l-4 border-sky-500 p-4 rounded-r-lg">
                        <h2 class="font-semibold text-sky-800">Step 2: Reset Password</h2>
                        <p class="text-gray-600 text-sm mt-1">Enter the verification code sent to your email and create a new password.</p>
                    </div>
                    
                    <div class="flex items-center mb-6 p-3 bg-blue-50 rounded-lg text-sky-700 text-sm">
                        <i class="fas fa-envelope-circle-check mr-3 text-lg text-sky-500"></i>
                        <span>Code sent to <strong x-text="maskEmail(email)" class="font-mono"></strong></span>
                    </div>
                    
                    <form @submit.prevent="verifyAndReset" class="space-y-6" action="{% url 'password_reset_verify' %}" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="email" :value="email">
                        
                        <div>
                            <label for="verificationCode" class="block text-sm font-medium text-gray-700 mb-1">Verification Code</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-key text-gray-400"></i>
                                </div>
                                <input 
                                    type="text" 
                                    id="verificationCode" 
                                    name="verification_code"
                                    x-model="verificationCode" 
                                    maxlength="6"
                                    class="pl-10 w-full border border-gray-300 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-all code-input bg-gray-50"
                                    placeholder="000000"
                                    required
                                    @input="formatCodeInput"
                                >
                            </div>
                            <div x-show="codeError" class="text-red-500 text-sm mt-1" x-text="codeError"></div>
                            
                            <div class="mt-2 flex justify-between items-center text-sm">
                                <span x-show="countdown > 0" class="text-gray-600 flex items-center">
                                    <i class="fas fa-clock mr-1 text-sky-500"></i>
                                    Expires in <span x-text="countdown" class="font-medium text-sky-700 mx-1"></span> seconds
                                </span>
                                <button 
                                    type="button" 
                                    @click="resendCode"
                                    :disabled="countdown > 0 || loading"
                                    class="text-sky-600 hover:text-sky-800 disabled:text-gray-400 disabled:cursor-not-allowed hover:underline flex items-center"
                                >
                                    <i class="fas fa-sync-alt mr-1" :class="{'animate-spin': resendLoading}"></i>
                                    <span x-show="countdown > 0">Resend in <span x-text="countdown"></span>s</span>
                                    <span x-show="countdown === 0">Resend code</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-100 my-4 pt-4">
                            <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-lock text-gray-400"></i>
                                </div>
                                <input 
                                    :type="showPassword ? 'text' : 'password'"
                                    id="newPassword" 
                                    name="new_password"
                                    x-model="newPassword" 
                                    class="pl-10 w-full border border-gray-300 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-all"
                                    placeholder="Create new password"
                                    required
                                    minlength="8"
                                    @input="checkPasswordStrength"
                                >
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                    <button type="button" @click="showPassword = !showPassword" class="text-gray-400 hover:text-gray-600">
                                        <i :class="showPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                                    </button>
                                </div>
                            </div>
                            <div x-show="passwordError" class="text-red-500 text-sm mt-1" x-text="passwordError"></div>
                            
                            <!-- Password strength meter -->
                            <div class="mt-2">
                                <div class="flex justify-between mb-1">
                                    <span class="text-xs text-gray-500">Password strength:</span>
                                    <span 
                                        class="text-xs font-medium" 
                                        :class="{
                                            'text-red-500': passwordStrength === 'weak',
                                            'text-yellow-500': passwordStrength === 'medium',
                                            'text-green-500': passwordStrength === 'strong'
                                        }"
                                        x-text="passwordStrength === 'weak' ? 'Weak' : passwordStrength === 'medium' ? 'Medium' : 'Strong'"
                                    ></span>
                                </div>
                                <div class="h-1 w-full bg-gray-200 rounded-full overflow-hidden">
                                    <div 
                                        class="h-1 transition-all duration-300"
                                        :class="{
                                            'bg-red-500': passwordStrength === 'weak',
                                            'bg-yellow-500': passwordStrength === 'medium',
                                            'bg-green-500': passwordStrength === 'strong'
                                        }"
                                        :style="{
                                            width: passwordStrength === 'weak' ? '33%' : passwordStrength === 'medium' ? '66%' : '100%'
                                        }"
                                    ></div>
                                </div>
                            </div>
                            
                            <div class="mt-2 grid grid-cols-2 gap-2">
                                <div class="text-xs text-gray-500 flex items-center" :class="newPassword.length >= 8 ? 'text-green-600' : 'text-gray-500'">
                                    <i class="fas" :class="newPassword.length >= 8 ? 'fa-check-circle text-green-500' : 'fa-circle text-gray-300'"></i>
                                    <span class="ml-1">At least 8 characters</span>
                                </div>
                                <div class="text-xs text-gray-500 flex items-center" :class="/[A-Z]/.test(newPassword) ? 'text-green-600' : 'text-gray-500'">
                                    <i class="fas" :class="/[A-Z]/.test(newPassword) ? 'fa-check-circle text-green-500' : 'fa-circle text-gray-300'"></i>
                                    <span class="ml-1">Uppercase letter</span>
                                </div>
                                <div class="text-xs text-gray-500 flex items-center" :class="/[0-9]/.test(newPassword) ? 'text-green-600' : 'text-gray-500'">
                                    <i class="fas" :class="/[0-9]/.test(newPassword) ? 'fa-check-circle text-green-500' : 'fa-circle text-gray-300'"></i>
                                    <span class="ml-1">Number</span>
                                </div>
                                <div class="text-xs text-gray-500 flex items-center" :class="/[^A-Za-z0-9]/.test(newPassword) ? 'text-green-600' : 'text-gray-500'">
                                    <i class="fas" :class="/[^A-Za-z0-9]/.test(newPassword) ? 'fa-check-circle text-green-500' : 'fa-circle text-gray-300'"></i>
                                    <span class="ml-1">Special character</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-lock text-gray-400"></i>
                                </div>
                                <input 
                                    :type="showPassword ? 'text' : 'password'"
                                    id="confirmPassword" 
                                    name="confirm_password"
                                    x-model="confirmPassword" 
                                    class="pl-10 w-full border border-gray-300 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-all"
                                    placeholder="Confirm new password"
                                    required
                                >
                            </div>
                            <div x-show="confirmError" class="text-red-500 text-sm mt-1" x-text="confirmError"></div>
                            <div x-show="confirmPassword && newPassword === confirmPassword" class="text-green-500 text-sm mt-1 flex items-center">
                                <i class="fas fa-check-circle mr-1"></i> Passwords match
                            </div>
                        </div>
                        
                        <button 
                            type="submit" 
                            class="w-full bg-gradient-to-r from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 text-white font-medium py-3 px-4 rounded-lg transition-all focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 shadow-md hover:shadow-lg hover:-translate-y-0.5"
                            :disabled="loading"
                        >
                            <span x-show="!loading">Reset Password</span>
                            <span x-show="loading" class="flex items-center justify-center">
                                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Resetting Password...
                            </span>
                        </button>
                        
                        <div class="text-center">
                            <button 
                                type="button" 
                                @click="goBack"
                                class="text-sky-600 hover:text-sky-800 text-sm hover:underline"
                            >
                                <i class="fas fa-arrow-left mr-1"></i> Back to email entry
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Step 3: Success -->
                <div x-show="step === 'success'" class="p-8 text-center fade-in" x-cloak>
                    <div class="w-24 h-24 bg-gradient-to-br from-green-400 to-green-600 text-white rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                        <i class="fas fa-check text-4xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-3">Password Reset Successfully!</h2>
                    <p class="text-gray-600 mb-8">Your password has been updated. You can now log in with your new password.</p>
                    
                    <div class="bg-green-50 border border-green-100 rounded-lg p-4 mb-6 text-left">
                        <h3 class="font-medium text-green-800 flex items-center">
                            <i class="fas fa-shield-alt mr-2"></i>
                            Security Tip
                        </h3>
                        <p class="text-green-700 text-sm mt-1">Remember to use a unique password for each of your accounts to maximize security.</p>
                    </div>
                    
                    <a 
                        href="{% url 'login' %}" 
                        class="inline-block bg-gradient-to-r from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 text-white font-medium py-3 px-8 rounded-lg transition-all focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 shadow-md hover:shadow-lg hover:-translate-y-0.5"
                    >
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        Go to Login
                    </a>
                </div>
            </div>
        </main>
        
        <!-- Enhanced Footer -->
        <footer class="bg-gradient-to-r from-sky-50 to-sky-100 border-t border-sky-100 py-8">
            <div class="container mx-auto px-4 md:px-6">
                <div class="text-center text-gray-600 text-sm">
                    <div class="flex items-center justify-center space-x-4 mb-4">
                        <a href="{% url 'homepage' %}" class="text-sky-600 hover:text-sky-800 transition-colors">Home</a>
                        <span class="text-gray-300">|</span>
                        <a href="#" class="text-sky-600 hover:text-sky-800 transition-colors">About</a>
                        <span class="text-gray-300">|</span>
                        <a href="#" class="text-sky-600 hover:text-sky-800 transition-colors">Resources</a>
                        <span class="text-gray-300">|</span>
                        <a href="#" class="text-sky-600 hover:text-sky-800 transition-colors">Contact</a>
                    </div>
                    <p>&copy; 2025 Mental Health Platform for Cameroonian Combat Athletes</p>
                    <p class="mt-2 flex items-center justify-center">
                        Need help? <a href="#" class="text-sky-600 hover:underline ml-1">Contact Support</a>
                    </p>
                </div>
            </div>
        </footer>
        
        <!-- Notification Toast with improved animation -->
        <div 
            x-show="notification.show" 
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 transform translate-y-2"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100 transform translate-y-0"
            x-transition:leave-end="opacity-0 transform translate-y-2"
            @click="notification.show = false"
            class="fixed bottom-4 right-4 bg-white rounded-lg shadow-xl border-l-4 py-3 px-5 cursor-pointer z-50 max-w-sm flex items-center"
            :class="{
                'border-green-500': notification.type === 'success',
                'border-red-500': notification.type === 'error',
                'border-sky-500': notification.type === 'info'
            }"
        >
            <div class="flex-shrink-0 mr-3">
                <div 
                    class="w-10 h-10 rounded-full flex items-center justify-center"
                    :class="{
                        'bg-green-100': notification.type === 'success',
                        'bg-red-100': notification.type === 'error',
                        'bg-sky-100': notification.type === 'info'
                    }"
                >
                    <i class="fas text-xl" :class="{
                        'fa-check-circle text-green-500': notification.type === 'success',
                        'fa-exclamation-circle text-red-500': notification.type === 'error',
                        'fa-info-circle text-sky-500': notification.type === 'info'
                    }"></i>
                </div>
            </div>
            <div>
                <p class="font-medium text-gray-800" x-text="notification.title"></p>
                <p class="text-sm text-gray-600" x-text="notification.message"></p>
            </div>
            <div class="ml-auto">
                <button class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        function passwordReset() {
            return {
                step: 'request', // 'request', 'verify', 'success'
                email: '',
                verificationCode: '',
                newPassword: '',
                confirmPassword: '',
                loading: false,
                resendLoading: false,
                emailError: '',
                codeError: '',
                passwordError: '',
                confirmError: '',
                countdown: 0,
                countdownTimer: null,
                showPassword: false,
                passwordStrength: 'weak',
                notification: {
                    show: false,
                    type: 'info', // 'success', 'error', 'info'
                    title: '',
                    message: '',
                    timeout: null
                },
                
                // Initialize component
                init() {
                    // Check if there's a password reset token in the URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const token = urlParams.get('token');
                    const email = urlParams.get('email');
                    
                    if (token && email) {
                        this.email = email;
                        this.step = 'verify';
                        this.startCountdown(300); // Start 5-minute countdown
                    }
                },
                
                // Mask email for display (e.g., j***n@example.com)
                maskEmail(email) {
                    if (!email) return '';
                    const [name, domain] = email.split('@');
                    if (name.length <= 2) {
                        return name.charAt(0) + '***@' + domain;
                    }
                    return name.charAt(0) + '***' + name.slice(-1) + '@' + domain;
                },
                
                // Format verification code input (add spaces for readability)
                formatCodeInput(event) {
                    let value = event.target.value.replace(/\s/g, '');
                    if (value.length > 6) {
                        value = value.substring(0, 6);
                    }
                    this.verificationCode = value;
                },
                
                // Check password strength
                checkPasswordStrength() {
                    if (!this.newPassword) {
                        this.passwordStrength = 'weak';
                        return;
                    }
                    
                    // Check password strength criteria
                    const hasLength = this.newPassword.length >= 8;
                    const hasUpper = /[A-Z]/.test(this.newPassword);
                    const hasLower = /[a-z]/.test(this.newPassword);
                    const hasNumber = /[0-9]/.test(this.newPassword);
                    const hasSpecial = /[^A-Za-z0-9]/.test(this.newPassword);
                    
                    // Calculate strength
                    let strength = 0;
                    if (hasLength) strength += 1;
                    if (hasUpper) strength += 1;
                    if (hasLower) strength += 1;
                    if (hasNumber) strength += 1;
                    if (hasSpecial) strength += 1;
                    
                    if (strength <= 2) {
                        this.passwordStrength = 'weak';
                    } else if (strength <= 4) {
                        this.passwordStrength = 'medium';
                    } else {
                        this.passwordStrength = 'strong';
                    }
                },
                
                // Start countdown timer
                startCountdown(seconds) {
                    this.countdown = seconds;
                    clearInterval(this.countdownTimer);
                    
                    this.countdownTimer = setInterval(() => {
                        this.countdown -= 1;
                        
                        if (this.countdown <= 0) {
                            clearInterval(this.countdownTimer);
                        }
                    }, 1000);
                },
                
                // Show notification
                showNotification(type, title, message, duration = 5000) {
                    clearTimeout(this.notification.timeout);
                    
                    this.notification = {
                        show: true,
                        type,
                        title,
                        message
                    };
                    
                    this.notification.timeout = setTimeout(() => {
                        this.notification.show = false;
                    }, duration);
                },
                
                // Request password reset code
                async requestReset() {
                    // Validate email
                    if (!this.email) {
                        this.emailError = 'Please enter your email address';
                        return;
                    }
                    
                    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.email)) {
                        this.emailError = 'Please enter a valid email address';
                        return;
                    }
                    
                    this.emailError = '';
                    this.loading = true;
                    
                    try {
                        // Create form data
                        const formData = new FormData();
                        formData.append('email', this.email);
                        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                        
                        // Call Django's forgot password endpoint
                        const response = await fetch('{% url "forgot_password" %}', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            this.step = 'verify';
                            this.startCountdown(300); // 5 minutes
                            
                            this.showNotification(
                                'success', 
                                'Code Sent', 
                                data.message || 'We\'ve sent a verification code to your email address.'
                            );
                        } else {
                            this.showNotification(
                                'error', 
                                'Error', 
                                data.message || 'Failed to send verification code. Please try again.'
                            );
                        }
                    } catch (error) {
                        this.showNotification(
                            'error', 
                            'Error', 
                            'Network error. Please try again.'
                        );
                    } finally {
                        this.loading = false;
                    }
                },
                
                // Resend verification code
                async resendCode() {
                    if (this.countdown > 0) return;
                    
                    this.resendLoading = true;
                    
                    try {
                        const formData = new FormData();
                        formData.append('email', this.email);
                        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                        
                        // Call Django's resend endpoint
                        const response = await fetch('{% url "resend_verification_code" %}', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            this.startCountdown(300); // Reset to 5 minutes
                            
                            this.showNotification(
                                'success', 
                                'Code Resent', 
                                data.message || 'A new verification code has been sent to your email.'
                            );
                        } else {
                            this.showNotification(
                                'error', 
                                'Error', 
                                data.message || 'Failed to resend verification code. Please try again.'
                            );
                        }
                    } catch (error) {
                        this.showNotification(
                            'error', 
                            'Error', 
                            'Network error. Please try again.'
                        );
                    } finally {
                        this.resendLoading = false;
                    }
                },
                
                // Verify code and reset password
                async verifyAndReset() {
                    // Validate verification code
                    if (!this.verificationCode || this.verificationCode.length !== 6) {
                        this.codeError = 'Please enter a valid 6-digit code';
                        return;
                    }
                    
                    // Validate password
                    if (!this.newPassword || this.newPassword.length < 8) {
                        this.passwordError = 'Password must be at least 8 characters';
                        return;
                    }
                    
                    if (this.newPassword !== this.confirmPassword) {
                        this.confirmError = 'Passwords do not match';
                        return;
                    }
                    
                    this.codeError = '';
                    this.passwordError = '';
                    this.confirmError = '';
                    this.loading = true;
                    
                    try {
                        // Create form data
                        const formData = new FormData();
                        formData.append('email', this.email);
                        formData.append('verification_code', this.verificationCode);
                        formData.append('new_password', this.newPassword);
                        formData.append('confirm_password', this.confirmPassword);
                        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                        
                        // Call Django's password reset verify endpoint
                        const response = await fetch('{% url "password_reset_verify" %}', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            this.step = 'success';
                            
                            this.showNotification(
                                'success', 
                                'Password Reset', 
                                data.message || 'Your password has been successfully updated.'
                            );
                        } else {
                            if (data.errors) {
                                if (data.errors.verification_code) {
                                    this.codeError = data.errors.verification_code[0];
                                }
                                if (data.errors.new_password) {
                                    this.passwordError = data.errors.new_password[0];
                                }
                                if (data.errors.confirm_password) {
                                    this.confirmError = data.errors.confirm_password[0];
                                }
                            }
                            
                            this.showNotification(
                                'error', 
                                'Error', 
                                data.message || 'Failed to reset password. Please try again.'
                            );
                        }
                    } catch (error) {
                        this.showNotification(
                            'error', 
                            'Error', 
                            'Network error. Please try again.'
                        );
                    } finally {
                        this.loading = false;
                    }
                },
                
                // Go back to email entry
                goBack() {
                    this.step = 'request';
                    this.verificationCode = '';
                    this.newPassword = '';
                    this.confirmPassword = '';
                    this.codeError = '';
                    this.passwordError = '';
                    this.confirmError = '';
                }
            }
        }
    </script>
</body>
</html>